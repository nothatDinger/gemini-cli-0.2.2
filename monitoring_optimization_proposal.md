# ç›‘æ§æ•°æ®ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ” é—®é¢˜åˆ†æ

å½“å‰ç›‘æ§ç³»ç»Ÿå­˜åœ¨æ˜¾è‘—çš„æ•°æ®é‡å¤é—®é¢˜ï¼š

### é‡å¤æ•°æ®ç»Ÿè®¡
- **LLMè°ƒç”¨**ï¼šendäº‹ä»¶æ¯”startäº‹ä»¶å¤§çº¦å¢åŠ 50-70%çš„æ•°æ®é‡ï¼ˆä¸»è¦æ˜¯responseTextï¼‰
- **å·¥å…·è°ƒç”¨**ï¼šendäº‹ä»¶æ¯”startäº‹ä»¶å¤§çº¦å¢åŠ 200-300%çš„æ•°æ®é‡ï¼ˆä¸»è¦æ˜¯resultå’ŒresultDisplayï¼‰
- **é‡å¤å­—æ®µ**ï¼šid, model, promptId, startTime, requestText/args ç­‰åœ¨startå’Œendäº‹ä»¶ä¸­å®Œå…¨ç›¸åŒ

## ğŸ’¡ ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šèåˆå¼è®°å½•æ¨¡å¼ï¼ˆå¼ºçƒˆæ¨èï¼‰â­

**æ ¸å¿ƒæ€æƒ³**ï¼šå®Œå…¨å–æ¶ˆstartäº‹ä»¶ï¼Œåªåœ¨è°ƒç”¨ç»“æŸæ—¶è®°å½•ä¸€ä¸ªåŒ…å«å®Œæ•´ä¿¡æ¯çš„äº‹ä»¶

#### é©å‘½æ€§çš„ç®€åŒ–ï¼š

```typescript
// å½“å‰æ¨¡å¼ï¼š2ä¸ªäº‹ä»¶ï¼Œå¤§é‡é‡å¤
// START: {"type":"llm_call","event":"start","data":{...åŸºç¡€æ•°æ®...}}
// END:   {"type":"llm_call","event":"end","data":{...åŸºç¡€æ•°æ®+ç»“æœæ•°æ®...}}

// èåˆæ¨¡å¼ï¼š1ä¸ªäº‹ä»¶ï¼Œé›¶é‡å¤
// COMPLETED: {"type":"llm_call","event":"completed","data":{...å®Œæ•´æ•°æ®...}}
```

#### é¢„æœŸèŠ‚çœï¼š
- **å­˜å‚¨ç©ºé—´**ï¼š60-70%å‡å°‘ï¼ˆæ¶ˆé™¤æ‰€æœ‰é‡å¤+å‡å°‘ä¸€åŠäº‹ä»¶æ•°é‡ï¼‰
- **IOæ“ä½œ**ï¼šå‡å°‘50%çš„å†™å…¥æ“ä½œ
- **è§£æå¤æ‚åº¦**ï¼šå®Œå…¨æ¶ˆé™¤start/endåŒ¹é…é€»è¾‘

### æ–¹æ¡ˆ2ï¼šå·®é‡è®°å½•æ¨¡å¼

**æ ¸å¿ƒæ€æƒ³**ï¼šend/erroräº‹ä»¶åªè®°å½•ä¸startäº‹ä»¶çš„å·®å¼‚æ•°æ®

#### ä¿®æ”¹åçš„äº‹ä»¶ç»“æ„ï¼š

```typescript
// STARTäº‹ä»¶ - è®°å½•å®Œæ•´çš„åˆå§‹æ•°æ®
{
  "timestamp": "2025-09-10T02:06:06.339Z",
  "type": "llm_call", 
  "event": "start",
  "data": {
    "id": "llm-xxx",
    "model": "gemini-2.5-pro",
    "promptId": "xxx",
    "startTime": 1757469966339,
    "status": "started",
    "requestText": [/* å®Œæ•´è¯·æ±‚æ•°æ® */]
  }
}

// ENDäº‹ä»¶ - åªè®°å½•å·®å¼‚æ•°æ®
{
  "timestamp": "2025-09-10T02:06:11.968Z",
  "type": "llm_call",
  "event": "end", 
  "data": {
    "id": "llm-xxx",  // ä»…ä¿ç•™IDç”¨äºå…³è”
    "endTime": 1757469971968,
    "duration": 5629,
    "status": "completed",
    "inputTokens": 5740,
    "outputTokens": 148,
    "totalTokens": 6144,
    "responseText": [/* å“åº”æ•°æ® */]
    // ç§»é™¤é‡å¤çš„ï¼šmodel, promptId, startTime, requestText
  }
}
```

#### é¢„æœŸèŠ‚çœï¼š
- **LLMè°ƒç”¨**ï¼šçº¦40-50%çš„æ•°æ®é‡å‡å°‘
- **å·¥å…·è°ƒç”¨**ï¼šçº¦60-70%çš„æ•°æ®é‡å‡å°‘
- **æ€»ä½“**ï¼šçº¦50-60%çš„traceæ–‡ä»¶å¤§å°å‡å°‘

### æ–¹æ¡ˆ2ï¼šå¼•ç”¨å¼è®°å½•æ¨¡å¼

**æ ¸å¿ƒæ€æƒ³**ï¼šendäº‹ä»¶é€šè¿‡IDå¼•ç”¨startäº‹ä»¶ï¼Œå®Œå…¨ä¸é‡å¤åŸºç¡€æ•°æ®

```typescript
// ENDäº‹ä»¶ - çº¯å·®å¼‚æ•°æ®
{
  "timestamp": "2025-09-10T02:06:11.968Z",
  "type": "llm_call",
  "event": "end",
  "ref": "llm-xxx",  // å¼•ç”¨startäº‹ä»¶çš„ID
  "data": {
    "endTime": 1757469971968,
    "duration": 5629,
    "status": "completed",
    "responseText": [/* åªæœ‰å“åº”æ•°æ® */]
  }
}
```

## ğŸ› ï¸ èåˆæ¨¡å¼å®æ–½æ–¹æ¡ˆ

### æ–°çš„äº‹ä»¶æ¶æ„ï¼š

```typescript
// LLMè°ƒç”¨ - åªæœ‰ä¸€ä¸ªå®Œæ•´äº‹ä»¶
{
  "timestamp": "2025-09-10T02:06:11.968Z",
  "type": "llm_call",
  "event": "completed", // æˆ– "error"
  "data": {
    "id": "llm-xxx",
    "model": "gemini-2.5-pro", 
    "promptId": "xxx",
    "startTime": 1757469966339,
    "endTime": 1757469971968,
    "duration": 5629,
    "status": "completed",
    "requestText": [/* è¯·æ±‚æ•°æ® */],
    "responseText": [/* å“åº”æ•°æ® */],
    "inputTokens": 5740,
    "outputTokens": 148,
    "totalTokens": 6144
  }
}

// å·¥å…·è°ƒç”¨ - åªæœ‰ä¸€ä¸ªå®Œæ•´äº‹ä»¶  
{
  "timestamp": "2025-09-10T02:06:21.050Z",
  "type": "tool_call",
  "event": "completed", // æˆ– "error" æˆ– "cancelled"
  "data": {
    "id": "tool-xxx",
    "toolName": "run_shell_command",
    "startTime": 1757469972014,
    "endTime": 1757469981050, 
    "duration": 9036,
    "executionDuration": 279,
    "status": "completed",
    "args": {/* å‚æ•° */},
    "result": "/* ç»“æœ */",
    "resultDisplay": "/* æ˜¾ç¤ºç»“æœ */"
  }
}
```

### å®æ–½æ­¥éª¤ï¼š

#### é˜¶æ®µ1ï¼šç›‘æ§æœåŠ¡é‡æ„

1. **ä¿®æ”¹MonitoringService**ï¼š
   - åœ¨`endLLMCall`ä¸­ç§»é™¤é‡å¤å­—æ®µçš„è®°å½•
   - åœ¨`endToolCall`ä¸­ç§»é™¤é‡å¤å­—æ®µçš„è®°å½•
   - ä¿æŒå‘åå…¼å®¹æ€§ï¼ˆæ·»åŠ é…ç½®å¼€å…³ï¼‰

2. **ä¿®æ”¹äº‹ä»¶å¤„ç†å™¨**ï¼š
   - ç”˜ç‰¹å›¾è§£æå™¨éœ€è¦åˆå¹¶start/endæ•°æ®
   - ä¿æŒç°æœ‰APIä¸å˜

3. **é…ç½®å¼€å…³**ï¼š
   ```typescript
   // åœ¨monitoring.tsä¸­æ·»åŠ 
   private enableOptimizedRecording = true; // é»˜è®¤å¯ç”¨ä¼˜åŒ–
   ```

### é˜¶æ®µ2ï¼šå¼•ç”¨å¼è®°å½•æ¨¡å¼ï¼ˆå¯é€‰ï¼‰

é€‚ç”¨äºå¯¹å­˜å‚¨ç©ºé—´è¦æ±‚æé«˜çš„åœºæ™¯ã€‚

## ğŸ“Š å½±å“è¯„ä¼°

### ä¼˜ç‚¹ï¼š
- âœ… æ˜¾è‘—å‡å°‘å­˜å‚¨ç©ºé—´ï¼ˆ50-60%ï¼‰
- âœ… å‡å°‘ç½‘ç»œä¼ è¾“é‡
- âœ… æé«˜å†™å…¥æ€§èƒ½
- âœ… ä¿æŒæ•°æ®å®Œæ•´æ€§

### è€ƒè™‘å› ç´ ï¼š
- âš ï¸ è§£æé€»è¾‘éœ€è¦åˆå¹¶start/endæ•°æ®
- âš ï¸ éœ€è¦å¤„ç†å­¤ç«‹çš„endäº‹ä»¶ï¼ˆstartäº‹ä»¶ä¸¢å¤±çš„æƒ…å†µï¼‰
- âš ï¸ å‘åå…¼å®¹æ€§éœ€è¦è€ƒè™‘

## ğŸ”„ è¿ç§»ç­–ç•¥

1. **é…ç½®é©±åŠ¨**ï¼šé€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶æ˜¯å¦å¯ç”¨ä¼˜åŒ–
2. **æ¸è¿›å¼è¿ç§»**ï¼šæ–°äº‹ä»¶ä½¿ç”¨ä¼˜åŒ–æ ¼å¼ï¼Œæ—§äº‹ä»¶ä¿æŒå…¼å®¹
3. **è§£æå™¨é€‚é…**ï¼šç”˜ç‰¹å›¾ç­‰å·¥å…·è‡ªåŠ¨æ£€æµ‹å¹¶å¤„ç†ä¸¤ç§æ ¼å¼

## ğŸ’» å®ç°ç¤ºä¾‹

### ä¼˜åŒ–åçš„endLLMCallæ–¹æ³•ï¼š
```typescript
public endLLMCall(
  id: string, 
  status: 'completed' | 'error',
  // ... å…¶ä»–å‚æ•°
): void {
  const metrics = this.llmCalls.get(id);
  if (!metrics) return;

  // å·®é‡æ•°æ® - åªè®°å½•æ–°å¢å­—æ®µ
  const deltaData: Partial<LLMCallMetrics> = {
    id, // ä¿ç•™IDç”¨äºå…³è”
    endTime,
    duration: endTime - metrics.startTime,
    status,
    inputTokens,
    outputTokens,
    totalTokens,
    responseText
    // ç§»é™¤ï¼šmodel, promptId, startTime, requestText
  };

  this.recordEvent('llm_call', status === 'completed' ? 'end' : 'error', deltaData);
}
```

## ğŸ¯ å»ºè®®é‡‡ç”¨

**æ–¹æ¡ˆ1ï¼ˆå·®é‡è®°å½•æ¨¡å¼ï¼‰** æ˜¯æœ€ä½³å¹³è¡¡ï¼š
- å®æ–½ç®€å•
- å…¼å®¹æ€§å¥½  
- æ•ˆæœæ˜¾è‘—
- é£é™©è¾ƒä½

å¯ä»¥ç«‹å³å®æ–½å¹¶è·å¾—æ˜¾è‘—çš„å­˜å‚¨ä¼˜åŒ–æ•ˆæœã€‚
